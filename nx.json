{
  "defaultProject": "poslah",
  "targetDefaults": {
    "build": {
      "cache": true,
      "outputs": [
        "{options.outputPath}"
      ]
    },
    "serve": {
      "cache": false
    },
    "test": {
      "cache": true
    },
    "lint": {
      "cache": true
    },
    "@nx/js:tsc": {
      "cache": true,
      "dependsOn": [
        "^build"
      ],
      "inputs": [
        "default",
        "^default"
      ]
    },
    "@nx/jest:jest": {
      "cache": true,
      "inputs": [
        "default",
        "^default",
        "{workspaceRoot}/jest.preset.js"
      ],
      "options": {
        "passWithNoTests": true
      },
      "configurations": {
        "ci": {
          "ci": true,
          "codeCoverage": true
        }
      }
    },
    "build-and-watch-backend": {
      "executor": "@poslah/nx-poslah:nodemon",
      "options": {
        "ignore": [
          "./*/*/dist/**/*",
          "./{projectRoot}/src/build-info.json"
        ],
        "watch": [
          "./{projectRoot}/src/**/*",
          "./libs/util/src/**/*",
          "./libs/kit/src/**/*",
          "./libs/database/src/**/*"
        ],
        "delay": 1000,
        "ext": "ts,json,proto,{options.addExt}",
        "addExt": "",
        "exec": "nx run {projectName}:build",
        "cwd": "{workspaceRoot}",
        "outputPath": "{workspaceRoot}/{projectRoot}/dist"
      }
    },

    "run-and-watch-backend": {
      "executor": "@poslah/nx-poslah:nodemon",
      "options": {
        "watch": ["./dist-copy/**/*"],
        "ext": "js",
        "delay": 1000,
        "script": "node",
        "scriptArgs": ["./dist-copy/{projectRoot}/{options.executablePath}"],
        "cwd": "{workspaceRoot}/{projectRoot}",
        "executablePath": "src/main.js",
        "verbose": false,
        "logChangedFiles": false
      }
    },

    "build-service-ts": {
      "executor": "@poslah/nx-poslah:run",
      "options": {
        "outputPath": "{workspaceRoot}/{projectRoot}/dist",
        "commands": [
          "yarn tsx libs/kit/src/bin/build-info-gen.ts -s ntp -x '{\"$schema\":\"../../../build-info.schema.json\"}' {projectRoot}/src/build-info.json",
          "yarn tsc -p {projectRoot}/tsconfig.build.json",
          "yarn tsc-alias -p {projectRoot}/tsconfig.build.json",
          "cd {projectRoot}/dist && yarn rimraf '**/*/package.json'",
          "cd {projectRoot}/dist && yarn tsx '../../../libs/kit/src/bin/copy.ts' -i './**/*' '../dist-copy'"
        ],
        "stopOnFail": true,
        "printTiming": true,
        "cwd": "{workspaceRoot}"
      },
      "dependsOn": ["copy-assets"]
    },

    "copy-assets": {
      "executor": "@poslah/nx-poslah:run",
      "options": {
        "outputPath": "{workspaceRoot}/{projectRoot}/dist",
        "commands": [
          "yarn tsx 'libs/kit/src/bin/copy.ts' -i './{apps,libs}/**/*.{proto,lua,crt,key,pem}' -i './certs/*.{crt,key,pem}' -x '**/node_modules/**' -x '**/dist/**' -x '**/tsconfig.*.json' '{projectRoot}/dist'"
        ],
        "stopOnFail": true,
        "printTiming": true,
        "cwd": "{workspaceRoot}"
      }
    },

    "kill-nx-daemon": {
      "executor": "@poslah/nx-poslah:run",
      "options": {
        "commands": ["ps aux | grep 'nx/src' | grep -v grep | awk '{print $2}' | xargs kill"]
      }
    },

    "serve-backend": {
      "executor": "@poslah/nx-poslah:concurrently",
      "options": {
        "processes": [
          {
            "name": "build",
            "color": "cyan",
            "command": "yarn nx build-and-watch-backend {projectName}"
          },
          {
            "name": "run",
            "color": "yellow",
            "command": "yarn nx run-and-watch-backend {projectName}"
          }
        ],
        "cwd": "{workspaceRoot}"
      },
      "dependsOn": []
    },

    "generate-proto-code": {
      "executor": "@poslah/nx-poslah:run",
      "options": {
        "commands": [
          "mkdir -p ./src/generated/grpc",
          "$(yarn bin grpc_tools_node_protoc) --plugin=$(yarn bin protoc-gen-ts_proto) --ts_proto_opt=nestJs=true,forceLong=long,addGrpcMetadata=true,addNestjsRestParameter=true --ts_proto_out=./src/generated/grpc ./src/grpc/{protoFileName}.proto"
        ],
        "cwd": "{workspaceRoot}/{projectRoot}"
      }
    },

    "issue-service-cert": {
      "executor": "@poslah/nx-poslah:run",
      "options": {
        "hostname": "localhost",
        "commands": [
          "yarn ts-node 'libs/kit/src/bin/copy.ts' -i 'certs/ca.{key,crt}' '{projectRoot}'",

          "cd {projectRoot}/certs && openssl genrsa -out server.key 2048",
          "echo 'For 'Common Name', use 'localhost' since we are running this locally. This is important for hostname verification.'",
          "cd {projectRoot}/certs && openssl req -new -key server.key -out server.csr -subj \"/CN={hostname}\"",
          "cd {projectRoot}/certs && openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 365 -sha256",


          "cd {projectRoot}/certs && openssl genrsa -out client.key 2048",
          "echo 'The 'Common Name' here identifies the client, e.g., 'my-client-app''",
          "cd {projectRoot}/certs && openssl req -new -key client.key -out client.csr -subj \"/CN={projectName}\"",
          "cd {projectRoot}/certs && openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 365 -sha256"
        ],
        "cwd": "{workspaceRoot}"
      }
    }
  },
  "plugins": [
    {
      "plugin": "@nx/webpack/plugin",
      "options": {
        "buildTargetName": "build",
        "serveTargetName": "serve",
        "previewTargetName": "preview"
      }
    },
    {
      "plugin": "@nx/eslint/plugin",
      "options": {
        "targetName": "lint"
      }
    }
  ]
}
